const DATA_TYPES = {
    CELL_NAME: '单元格名称',
    JS_EXPR: 'JS表达式',
}

const ax = require('activex')
const _ = require('lodash')

function main(input, input_type, output, output_type, code) {
    try {
        code=JSON.parse(code)

        let _in;
        let _out;
        if (input_type === DATA_TYPES.CELL_NAME) {
            try {
                let excel = GetObject('', 'Excel.Application');
                _in = ax.toArray(excel.ActiveSheet.Range(input));
            } catch (e) {
                console.log('请先打开一个excel文档');
            }
        } else if (input_type === DATA_TYPES.TEXT) {    
            _in = input.split('\n')
        } else if (input_type === DATA_TYPES.JS_EXPR) {
            try {
                _in = eval(input) 
            }catch(e){
                console.log('请输入正确的JS表达式');
            }
        } else {
                    
        }

        if (output_type === DATA_TYPES.CELL_NAME) {
            try {
                let excel = GetObject('', 'Excel.Application')
                _out = excel.ActiveSheet.Range(output)
            } catch (e) {
                console.log('请先打开一个excel文档');
            }
        } else { //作为纯文本
            _out = output
        }
        _in.forEach((e, i, arr) => {
            let ret = eval(code);
            if (output_type === DATA_TYPES.CELL_NAME) {
                if (Array.isArray(ret)) {
                    _out.Offset(i, 0).Resize(1, ret.length).Value = ax.toVBArray(ret);
                }
                else
                    _out.Offset(i, 0).Value = ret

            }
        });
    } catch (e) {
        console.log(e)
    }

}

globalThis.main = main;